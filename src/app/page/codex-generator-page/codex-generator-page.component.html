@if (printMode) {
  <div class="ml-4 my-3 flex items-center print:hidden">
    <app-icon
      class="size-6 inline-block mr-2"
      icon="information-circle"
    ></app-icon>
    <span class="text-sm">
      Pour convertir votre codex en PDF, vous devez utiliser la fonction
      "Imprimer en PDF" de votre navigateur. Utilisez l'orientation "Portrait",
      le format "A4", aucune marge et imprimez les arrières-plans.
    </span>
  </div>
}

<hr
  class="print:hidden mx-20 my-10 border border-white [box-shadow:_-0_-0_10px_5px_white]"
/>

<div id="vs-start" [style.height]="vsBefore + 'px'"></div>

@for (page of displayedPages; track page) {
  <div class="flex justify-between mx-4 h-[1138.52px] print:mx-0">
    <div
      class="print:hidden text-white h-[29.7cm] flex flex-col gap-1 bg-[#2e2a31] p-2 flex-grow mr-4 relative"
    >
      @if (!printMode) {
        @if (isCoverPage(page)) {
          <div class="flex flex-col">
            <label
              class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
            >
              Titre de la page
            </label>
            <input
              class="text-[#2e2a31] h-[30px] pl-1"
              type="text"
              placeholder="Titre de la page"
              [(ngModel)]="page.title"
              (ngModelChange)="page.onChange()"
            />

            <label
              class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
            >
              Couleur
            </label>
            <div class="flex flex-row flex-wrap">
              <button
                class="w-[100px] h-[30px] border border-white flex items-center justify-center"
                [(colorPicker)]="page.color"
                cpAlphaChannel="disabled"
                [style.background-color]="page.color"
              >
                <app-icon class="size-5 inline-block" icon="brush"></app-icon>
              </button>

              @for (color of db.colors; track color) {
                <button
                  class="w-[30px] h-[30px] border border-white ml-2"
                  [style.background-color]="color"
                  (click)="page.color = color"
                ></button>
              }
            </div>

            <label
              class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
            >
              Auteur
            </label>
            <input
              class="text-[#2e2a31] h-[30px] pl-1"
              type="text"
              placeholder="Nom"
              [(ngModel)]="page.author"
              (ngModelChange)="page.onChange()"
            />
          </div>
        }

        @if (isSummaryPage(page)) {
          <div class="flex flex-col">
            <label
              class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
            >
              Couleur
            </label>
            <div class="flex flex-row flex-wrap">
              <button
                class="w-[100px] h-[30px] border border-white flex items-center justify-center"
                [(colorPicker)]="page.color"
                cpAlphaChannel="disabled"
                [style.background-color]="page.color"
              >
                <app-icon class="size-5 inline-block" icon="brush"></app-icon>
              </button>

              @for (color of db.colors; track color) {
                <button
                  class="w-[30px] h-[30px] border border-white ml-2"
                  [style.background-color]="color"
                  (click)="page.color = color"
                ></button>
              }
            </div>
          </div>
        }

        @if (isStandardPage(page)) {
          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Titre de la page
          </label>
          <input
            class="text-[#2e2a31] h-[30px] pl-1"
            type="text"
            placeholder="Titre de la page"
            [(ngModel)]="page.title"
            (ngModelChange)="page.onChange()"
          />

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Couleur
          </label>
          <div class="flex flex-row flex-wrap">
            <button
              class="w-[100px] h-[30px] border border-white flex items-center justify-center"
              [(colorPicker)]="page.color"
              cpAlphaChannel="disabled"
              [cpPositionRelativeToArrow]="true"
              [style.background-color]="page.color"
            >
              <app-icon class="size-5 inline-block" icon="brush"></app-icon>
            </button>

            @for (color of db.colors; track color) {
              <button
                class="w-[30px] h-[30px] border border-white ml-2"
                [style.background-color]="color"
                (click)="page.color = color"
              ></button>
            }
          </div>

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Entête de la page
          </label>
          <textarea
            class="text-[#2e2a31] pl-1 h-[85px]"
            placeholder="Entête de la page"
            [(ngModel)]="page.header"
            (ngModelChange)="page.onChange()"
          ></textarea>

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Sous titre de la page
          </label>
          <input
            class="text-[#2e2a31] h-[30px] pl-1"
            type="text"
            placeholder="Sous titre de la page"
            [(ngModel)]="page.subTitle"
            (ngModelChange)="page.onChange()"
          />

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Contenu
          </label>
          <textarea
            class="text-[#2e2a31] pl-1 flex-grow"
            placeholder="Contenu"
            [(ngModel)]="page.text"
            (ngModelChange)="page.onChange()"
          ></textarea>
        }

        @if (isTitlePage(page)) {
          <div class="flex flex-col">
            <label
              class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
            >
              Titre de la page
            </label>
            <input
              class="text-[#2e2a31] h-[30px] pl-1"
              type="text"
              placeholder="Titre de la page"
              [(ngModel)]="page.title"
              (ngModelChange)="page.onChange()"
            />

            <label
              class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
            >
              Couleur
            </label>
            <div class="flex flex-row flex-wrap">
              <button
                class="w-[100px] h-[30px] border border-white flex items-center justify-center"
                [(colorPicker)]="page.color"
                cpAlphaChannel="disabled"
                [cpPositionRelativeToArrow]="true"
                [style.background-color]="page.color"
              >
                <app-icon class="size-5 inline-block" icon="brush"></app-icon>
              </button>

              @for (color of db.colors; track color) {
                <button
                  class="w-[30px] h-[30px] border border-white ml-2"
                  [style.background-color]="color"
                  (click)="page.color = color"
                ></button>
              }
            </div>
          </div>
        }

        @if (isBestiaryPage(page)) {
          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Titre de la page
          </label>
          <input
            class="text-[#2e2a31] h-[30px] pl-1"
            type="text"
            placeholder="Titre de la page"
            [(ngModel)]="page.title"
            (ngModelChange)="page.onChange()"
          />

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Nom du PNJ
          </label>
          <div class="flex">
            <ng-autocomplete
              class="autocomplete flex-grow"
              [data]="db.npcs"
              searchKeyword="name"
              [initialValue]="page.npcName"
              [customFilter]="npcFilter"
              [itemTemplate]="npcTemplate"
              (inputChanged)="page.onNpcNameChange($event)"
              (selected)="page.onNpcSelected($event)"
              [focusFirst]="true"
              placeholder="Nom"
            ></ng-autocomplete>
            <button
              class="size-[30px] min-w-[30] flex items-center justify-center border border-white bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white"
              (click)="page.elite = !page.elite"
            >
              <app-icon
                class="size-5"
                [icon]="page.elite ? 'bolt' : 'bolt-slash'"
              ></app-icon>
            </button>

            <button
              class="size-[30px] min-w-[30] flex items-center justify-center border border-white bg-white text-[#2e2a31] mr-0.5 hover:bg-[#2e2a31] hover:text-white"
              (click)="page.incarnation = !page.incarnation"
            >
              <app-icon
                class="size-5"
                [icon]="page.incarnation ? 'sparkles' : 'star'"
              ></app-icon>
            </button>

            <button
              class="size-[30px] min-w-[30] flex items-center justify-center border border-white bg-white text-[#2e2a31] mr-0.5 hover:bg-[#2e2a31] hover:text-white"
              (click)="page.changeTwoColumns()"
            >
              <app-icon
                class="size-5"
                [icon]="page.twoColumns ? 'zoom-in' : 'zoom-out'"
              ></app-icon>
            </button>
          </div>

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Description
          </label>
          <textarea
            class="text-[#2e2a31] pl-1 flex-grow"
            placeholder="Description"
            [(ngModel)]="page.description"
            (ngModelChange)="page.onChange()"
          ></textarea>

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Citation
          </label>
          <textarea
            class="text-[#2e2a31] pl-1 h-[85px]"
            placeholder="Description"
            [(ngModel)]="page.quote"
            (ngModelChange)="page.onChange()"
          ></textarea>

          <label
            class="uppercase segoe-ui-bold-italic font-bold text-xs h-[30px] flex flex-col justify-center content-center text-center"
          >
            Auteur
          </label>
          <input
            class="text-[#2e2a31] h-[30px] pl-1"
            type="text"
            placeholder="Nom"
            [(ngModel)]="page.author"
            (ngModelChange)="page.onChange()"
          />
        }
      }
    </div>
    <div [id]="page.id" class="page group" [style.--color]="page.color">
      <div [id]="'content-' + page.id">
        @if (isTitlePage(page)) {
          <div class="bg-[#2e2a31] h-[29.7cm]">
            <div class="cover-title cover-title-smaller">{{ page.title }}</div>
          </div>
        }

        @if (isCoverPage(page)) {
          <div class="bg-[#2e2a31] h-[29.7cm]">
            <div class="cover-title">{{ page.title }}</div>

            <div
              class="cover-author absolute left-0 right-0 bottom-[80px] uppercase text-xl h-[30px] text-center tracking-[2px] segoe-ui-bold"
            >
              {{ page.author }}
            </div>

            <div
              class="absolute bottom-0 left-0 right-0 text-justify text-white text-xs p-2"
            >
              Ce codex a été généré en utilisant l'outil de
              <a class="underline" href="https://kng.magusgeek.com/">KNG</a>
              disponible à l'adresse
              <a class="underline" href="https://kng.magusgeek.com/codex"
                >https://kng.magusgeek.com/codex</a
              >. Le contenu des capacités standards est soumis aux droits
              d'auteur de ©Antre-Monde Editions
            </div>
          </div>
        }

        @if (isSummaryPage(page)) {
          <div
            class="text-center text-white min-h-[60px] pt-5 pb-4 uppercase text-lg tracking-[12px] page-title"
            [class.page-title-left]="page.index % 2"
            [class.page-title-right]="page.index % 2 === 0"
          >
            {{ page.title }}
          </div>
        }

        @if (isStandardPage(page)) {
          @if (page.title) {
            <div
              class="text-center text-white min-h-[60px] pt-5 pb-4 mb-5 uppercase text-lg tracking-[12px] page-title"
              [class.page-title-left]="page.index % 2"
              [class.page-title-right]="page.index % 2 === 0"
            >
              {{ page.title }}
            </div>
          }

          <div class="mx-[1.75cm]">
            <div
              class="article-content"
              [innerHTML]="converter.makeHtml(page.header)"
            ></div>

            @if (page.subTitle) {
              <div
                class="text-center text-white bg-[#2e2a31] min-h-[80px] py-5 mt-5 mb-2 uppercase text-4xl segoe-ui-bold font-bold npc-name"
              >
                {{ page.subTitle }}
              </div>
            }

            <div
              class="article-content two-columns"
              [innerHTML]="converter.makeHtml(page.text)"
            ></div>
          </div>

          @if (page.title) {
            @if (page.index % 2) {
              <div class="corner corner-right"></div>
            } @else {
              <div class="corner corner-left"></div>
            }
          }

          <div
            class="absolute bottom-0 left-[8cm] right-[8cm] py-1 h-[32px] bg-[#2e2a31] text-center text-white page-number"
          >
            - {{ page.index + 1 }} -
          </div>
        }

        @if (isBestiaryPage(page)) {
          @if (page.title) {
            <div
              class="text-center text-white min-h-[60px] pt-5 pb-4 uppercase text-lg tracking-[12px] page-title"
              [class.page-title-left]="page.index % 2"
              [class.page-title-right]="page.index % 2 === 0"
            >
              {{ page.title }}
            </div>
          }

          <div class="mx-[1.75cm]">
            <div
              class="text-center text-white bg-[#2e2a31] min-h-[80px] py-5 mt-10 mb-2 uppercase text-4xl segoe-ui-bold font-bold npc-name"
              [class.elite]="page.elite"
              [class.incarnation]="page.incarnation"
            >
              {{ page.npc?.name }}
            </div>

            @if (page.twoColumns) {
              <div class="flex items-start">
                <div
                  [id]="'description-' + page.id"
                  class="article-content w-[200px] flex-shrink-0 mr-2"
                  [innerHTML]="converter.makeHtml(page.description)"
                ></div>

                @if (page.npc) {
                  <app-npc
                    [id]="'npc-' + page.id"
                    [npc]="page.npc"
                    [style.transform]="'scale(' + page.npcScale + ')'"
                    [style.margin-bottom]="page.npcMarginBottom + 'px'"
                    class="origin-top-left"
                  ></app-npc>
                }
              </div>
            } @else {
              <div
                [id]="'description-' + page.id"
                class="article-content"
                [innerHTML]="converter.makeHtml(page.description)"
              ></div>

              @if (page.npc) {
                <div class="npc flex items-center justify-center my-5">
                  <app-npc
                    [id]="'npc-' + page.id"
                    [npc]="page.npc"
                    [style.transform]="'scale(' + page.npcScale + ')'"
                    [style.margin-bottom]="page.npcMarginBottom + 'px'"
                    class="origin-top"
                  ></app-npc>
                </div>
              }
            }

            @if (page.quote) {
              <div
                class="quote-content text-center"
                [innerHTML]="
                  converter.makeHtml('====« ====' + page.quote + '==== »====')
                "
              ></div>
              @if (page.author) {
                <div class="text-right">—&nbsp;{{ page.author }}</div>
              }
            }

            @if (page.title) {
              @if (page.index % 2) {
                <div class="corner corner-right"></div>
              } @else {
                <div class="corner corner-left"></div>
              }
            }

            <div
              class="absolute bottom-0 left-[8cm] right-[8cm] py-1 h-[32px] bg-[#2e2a31] text-center text-white page-number"
            >
              - {{ page.index + 1 }} -
            </div>
          </div>
        }
      </div>

      <div class="hidden group-hover:block">
        @if (page.index > 1) {
          <div class="absolute top-1 left-1 right-1 flex justify-between">
            <div class="flex gap-1">
              <button
                class="size-7 flex items-center justify-center border border-[#2e2a31] bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white hover:border-white"
                (click)="pageUp(page)"
              >
                <app-icon class="size-7" icon="arrow-up"></app-icon>
              </button>
              <button
                class="size-7 flex items-center justify-center border border-[#2e2a31] bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white hover:border-white"
                (click)="pageDown(page)"
              >
                <app-icon class="size-7" icon="arrow-down"></app-icon>
              </button>
            </div>

            <button
              class="size-7 flex items-center justify-center border border-[#2e2a31] bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white hover:border-white"
              (click)="pageRemove(page)"
            >
              <app-icon class="size-7" icon="X"></app-icon>
            </button>
          </div>
        }

        @if (page.index > 0) {
          <div class="absolute bottom-1 left-1 right-1 flex gap-2">
            <button
              class="h-7 p-1 flex items-center justify-center border border-[#2e2a31] bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white hover:border-white"
              (click)="addTitlePage(page.index)"
            >
              <app-icon
                class="size-5 inline-block"
                icon="plus-circle"
              ></app-icon>
              <span class="ml-1">Titre</span>
            </button>

            <button
              class="h-7 p-1 flex items-center justify-center border border-[#2e2a31] bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white hover:border-white"
              (click)="addStandardPage(page.index)"
            >
              <app-icon
                class="size-5 inline-block"
                icon="plus-circle"
              ></app-icon>
              <span class="ml-1">Standard</span>
            </button>

            <button
              class="h-7 p-1 flex items-center justify-center border border-[#2e2a31] bg-white text-[#2e2a31] mx-0.5 hover:bg-[#2e2a31] hover:text-white hover:border-white"
              (click)="addBestiaryPage(page.index)"
            >
              <app-icon
                class="size-5 inline-block"
                icon="plus-circle"
              ></app-icon>
              <span class="ml-1">Bestiaire</span>
            </button>
          </div>
        }
      </div>
    </div>
  </div>
}

<div [style.height]="vsAfter + 'px'"></div>

<ng-template #npcTemplate let-item>
  <a>
    <div
      class="inline-block size-4 rounded-full mr-1 relative top-[2px]"
      [style.background-color]="item.color"
    ></div>
    <strong [innerHTML]="item.name"></strong><br />
    <small class="capitalize">{{ item.type }} ({{ item.level }})</small>
  </a>
</ng-template>
